### DB服务
>该服务主要进行数据读写，提供统一的接口对数据进行操作，同时也对需要缓存的数据进行缓存。
提供使用共享内存来存储缓存数据和提供线程同步缓存数据到数据库。改服务器中通过线程实现数据的读写和同步。


#### 数据读写的策略
>当玩家登录游戏，读取数据的时候先从共享内存中读取，如果共享内存中不存在对应的数据，则从数据库中读取，从数据库中读取成功以后同时将需要缓存的数据存到共享内存中。之后每次读写对应的数据都只是操作对应的缓存。由于操作的内存是有限的，所以这个时候共享内是所有玩家争用的资源，不能让某个玩家离线了还一直占用资源而不释放，当某个玩家下线时，占用的共享内存就将其释放，将空间交换出来给其他的玩家。数据在共享内存中同样需要同步到数据库或者文件中，这里同步采用有更新时同步，没有更新时则忽略。由于使用了共享内存，所以同步比较容易，为了不影响正常写的数据，采用拷贝同步的方式同步。即将更新的数据拷贝一个备份出来同步，这样即不会影响到原来的数据，同样的也能将数据不丢失的保存到数据库中。【采用复制同步的方法】

>当收到数据请求时，先检查共享内存中是否有对应的数据，如果没有，则通知IO线程读取数据并作出响应，同时更新共享内存中的数据。使用共享内存避免线程之间共享出现的问题。

>该进程职责分明，主线程主要是读取和更新共享内存；IO线程主要是读取数据库中的数据并写到共享内存中，IO线程主要是接收主线程的请求然后读取数据并更新共享内存以及响应请求。


#### io线程
>该进程包含三种线程：读线程、写线程、同步线程。同步线程在不使用共享内存的情况下不被创建；读线程和写线程可以不受共享内存的控制，因为两个线程主要操作对象是数据库，只有需要的情况下会写共享内存；所有的控制均由配置文件控制。

##### 读线程
>读取数据库中的数据，如果设置了共享内存，同时也将读取结果写到内存中。

    注：使用该线程读取数据是要在共享内存中没有需要读取的请情况才会收到读取消息。

#### 写线程：
>将数据写到缓存或者数据库中，如果缓存中没有数据，需要将数据写到共享内存中或者数据库中；这里由于缓存有限，所以很多的写操作是直接操作数据库的。

    注：选择读线程或者是写线程由代码逻辑控制。

#### 同步线程：
>将共享内存中的数据同步到数据库中（注，需要在使用共享内存的情况下才能创建这个线程）。

#### 问题：
>如果数据库长时间不操作就会断开连接，即出现MySQL server has gone away错误。线程共享的单列对象在创建线程以前必须先创建

#### 数据读写与同步的过程
![db](/doc/diagram/db.png)